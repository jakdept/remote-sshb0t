---
- name: move allowed users
  set_fact:
    sshb0t_current_allowed_users: "{{ domain.allowed_users }}"

- name: process each github org
  include_tasks: github-org.yml
  loop: "{{ domain.allowed_github_org | default([]) }}"
  loop_control:
    loop_var: github_org_name

- name: process each gitlab group
  include_tasks: gitlab-group.yml
  loop: "{{ domain.allowed_gitlab_groups | default([]) }}"
  loop_control:
    loop_var: gitlab_group_name

# - name: deduplicate users

- name: show users
  debug:
    var: sshb0t_current_allowed_users
  delegate_to: localhost

- name: push user keys to server
  ansible.posix.authorized_key:
    user: root
    comment: "{{ item }}@{{ domain.url }}"
    key_options: "environment=\"SSH_USER={{ item}}\""
    key: "https://{{ domain.url }}/{{ item }}.keys"
  loop: "{{ domain.allowed_users }}"
